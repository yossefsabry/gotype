# Gotype Application Improvement Plan

## Overview
Incremental improvements focused on speed, responsiveness, and correctness. Align with AGENTS.md: small files, low allocations, avoid heavy refactors, and keep UI fast.

## Current State Notes
- clean not wanted code  for the application on modes section
- ModeQuote and ModeCustom constants exist but are not implemented.
- Zen helpers exist in internal/app/zen.go, but rendering does not hide UI during typing.
- Persistence is called on every key, click, and 80ms tick.
- Persister ignores save errors.
- Existing optimizations: LineCache, StatsHistory, render/words/textwrap benchmarks.

## Guiding Principles
- Keep changes incremental and easy to review.
- Prefer low-allocation paths in hot loops.
- Avoid large refactors unless they unblock performance or features.
- No new dependencies unless clearly justified.

---

# Phase 0: Stabilize and Fix Broken Edges (Day 1)
- i want only two modes for the appilaction time mode and word mode and remove
    any code that is not releated too this so work on this first

## 0.2 Rate-limit Persistence
Problem: syncPersistence is called on every key event and tick.

Tasks
- [ ] Add a debounce ticker (eg. 500ms) and only save on ticks.
- [ ] Always save immediately when a run finishes.

Simple code example
```go
persistTick := time.NewTicker(500 * time.Millisecond)
defer persistTick.Stop()

select {
case event := <-events:
    // handle event
case <-persistTick.C:
    a.syncPersistence(time.Now())
}
```

## 0.3 Storage Error Reporting
Problem: persister discards storage.Save errors.

Tasks
- [ ] Add errCh to Persister.
- [ ] Log errors to stderr and keep UI running.

Simple code example
```go
if err := storage.Save(p.path, data); err != nil {
    select {
    case p.errCh <- err:
    default:
    }
}
```

---

# Phase 1: Visible UX Improvements (Days 2-3)

## 1.1 Zen Mode UI (Complete Existing Helpers)
Goal: Hide non-essential UI while typing.

Tasks
- [ ] Use isZenTyping() in render_panels.go.
- [ ] Skip top bar, stats, keyboard during typing.
- [ ] Show minimal footer hint ("esc to quit").

Simple code example
```go
if isZenTyping(model) {
    drawFooterHint("esc to quit")
    return
}
```

## 1.2 Progress Indicator (Time + Words)
Goal: Show progress in footer without extra allocations.

Tasks
- [ ] Track progress in Model.UpdateDerived (reuse elapsed/time).
- [ ] Render a compact bar and percent.

Simple code example
```go
func (m *Model) progress() float64 {
    if m.Options.Mode == ModeWords {
        return float64(len(m.Text.Typed)) / float64(len(m.Text.Target))
    }
    if m.Timer.Started && m.Options.Duration > 0 {
        return float64(m.elapsedForStats(time.Now())) / float64(m.Options.Duration)
    }
    return 0
}
```

---

# Phase 2: Feature MVPs (Days 4-6)

## 2.1 Quote Mode (MVP)
Scope: Simple random quotes, no filters.

Tasks
- [ ] Add internal/app/quotes.go with ~20 curated quotes.
- [ ] Add Generator.BuildQuote() or Branch in Build() for ModeQuote.
- [ ] Wire ModeQuote selection in UI.

Simple code example
```go
func (g *Generator) BuildQuote() []rune {
    q := quotes[g.rng.Intn(len(quotes))]
    return []rune(q.Text)
}
```

## 2.2 Custom Text (File Only, MVP)
Scope: Read from ~/.config/gotype/custom.txt.

Tasks
- [ ] Load file on mode switch, show error if missing.
- [ ] Skip clipboard for now.

Simple code example
```go
data, err := os.ReadFile(customPath)
if err != nil {
    model.SetMessage("custom.txt not found", now, 3*time.Second)
    return
}
model.Text.Target = []rune(strings.TrimSpace(string(data)))
```

---

# Phase 3: Code Quality and Tests (Days 7-9)

## 3.1 Split persist.go (Only)
Goal: Keep files small without large refactors.

Tasks
- [ ] Move prefs conversion to persist_prefs.go.
- [ ] Move score logic to persist_scores.go.
- [ ] Move mode conversion to persist_modes.go.

## 3.2 Core Tests (Pure Functions)
Scope: Model and persistence only; no UI mocks.

Tasks
- [ ] model_test.go: AddRune, Backspace, UpdateDerived.
- [ ] persist_test.go: Round-trip load/save and score key format.

---

# Phase 4: Optional Polish (Later)

## 4.1 Render Flicker (If visible)
Current forceClear happens only on resize/theme change. Defer unless it is visible.

## 4.2 Analytics Dashboard (Later)
Use existing StatsHistory. Start with time-by-second WPM chart.

---

# Performance Targets (Aligned with Current Loop)
- Current update tick: 80ms (~12.5 fps). Either keep or reduce to 16ms if CPU allows.
- Key handling: avoid new allocations in AddRune/Backspace.
- Persistence: debounce to 500ms or more.

---

# Verification Checklist
- [ ] go build ./...
- [ ] go vet ./...
- [ ] go test ./...
- [ ] go test ./... -race (if concurrency touched)
- [ ] Quote mode renders text correctly
- [ ] Zen mode hides UI while typing
- [ ] Progress indicator updates without lag
- [ ] Persistence does not block UI

---

# Deprioritized Refactors
- Split model.go into many files (not needed at 313 lines).
- Create internal/render package (large change, low payoff now).
